<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huacainfo.ace.partyschool.dao.SignDao">

    <insert id="insertReg">
        insert into portal.users (user_id, account, password,
        sex, id_card, name,
        department_id, area_code, birthday,
        stauts, last_login_time, mobile,
        email, seat, user_level,
        create_time, fax, telphone,
        qq, openId, cur_syid,
        appOpenId)
        values (
        #{user.userId,jdbcType=VARCHAR}, #{user.account,jdbcType=VARCHAR}, #{user.password,jdbcType=VARCHAR},
        #{user.sex,jdbcType=VARCHAR}, #{user.idCard,jdbcType=VARCHAR}, #{user.name,jdbcType=VARCHAR},
        #{user.departmentId,jdbcType=VARCHAR}, #{user.areaCode,jdbcType=VARCHAR}, #{user.birthday,jdbcType=DATE},
        #{user.stauts,jdbcType=VARCHAR}, #{user.lastLoginTime,jdbcType=TIMESTAMP}, #{user.mobile,jdbcType=VARCHAR},
        #{user.email,jdbcType=VARCHAR}, #{user.seat,jdbcType=VARCHAR}, #{user.userLevel,jdbcType=VARCHAR},
        #{user.createTime,jdbcType=TIMESTAMP}, #{user.fax,jdbcType=VARCHAR}, #{user.telphone,jdbcType=VARCHAR},
        #{user.qq,jdbcType=VARCHAR}, #{user.openId,jdbcType=VARCHAR}, #{user.curSyid,jdbcType=VARCHAR},
        #{user.appOpenId,jdbcType=VARCHAR})
        ;
        insert into portal.users_role
        (user_id, role_id, create_time)
        values(#{user.userId,jdbcType=VARCHAR}, #{roleId,jdbcType=VARCHAR}, now())
        ;
        insert into portal.user_cfg (id, userId, cfgKey,cfgValue)
        values (#{user.userId,jdbcType=VARCHAR}, #{user.userId,jdbcType=VARCHAR}, 'portalType','1');
    </insert>

    <select id="isExistByMobile" resultType="int">
        select count(*)
        from portal.users
        where mobile = #{tel}
        or account = #{tel}
    </select>


    <resultMap id="AcctResultMap" type="com.huacainfo.ace.partyschool.vo.AccountVo">
        <result column="regType" jdbcType="VARCHAR" property="regType"/>
        <result column="headimgurl" jdbcType="VARCHAR" property="avatarUrl"/>
        <result column="nickName" jdbcType="VARCHAR" property="nickName"/>
        <association property="student" column="sid" javaType="com.huacainfo.ace.partyschool.vo.StudentVo">
            <id column="sid" jdbcType="VARCHAR" property="id"/>
            <result column="sPid" jdbcType="VARCHAR" property="pid"/>
            <result column="sName" jdbcType="VARCHAR" property="name"/>
            <result column="sMobile" jdbcType="VARCHAR" property="mobile"/>
            <result column="sIdCard" jdbcType="CHAR" property="idCard"/>
            <result column="sPolitical" jdbcType="VARCHAR" property="political"/>
            <result column="sWUName" jdbcType="VARCHAR" property="workUnitName"/>
            <result column="sPostName" jdbcType="VARCHAR" property="postName"/>
            <result column="sClsId" jdbcType="VARCHAR" property="classId"/>
            <result column="sClsName" jdbcType="VARCHAR" property="clsName"/>
        </association>
        <association property="teacher" column="tid" javaType="com.huacainfo.ace.partyschool.vo.TeacherVo">
            <id property="id" jdbcType="VARCHAR" column="tid"/>
            <result column="tType" jdbcType="CHAR" property="category"/>
            <result column="tName" jdbcType="VARCHAR" property="name"/>
            <result column="tMobile" jdbcType="VARCHAR" property="mobile"/>
            <result column="tIdCard" jdbcType="CHAR" property="idCard"/>
            <result column="tPhotoUrl" jdbcType="VARCHAR" property="photoUrl"/>
        </association>
    </resultMap>

    <select id="findByAcct" parameterType="java.lang.String" resultMap="AcctResultMap">
        select
        ui.nickname, ui.headimgurl,
        u.sex,

        s.id as sid,
        s.pid as sPid, s.name as sName, s.mobile as sMobile, s.idCard as sIdCard,
        s.political as sPolitical, s.workUnitName as sWUName, s.postName as sPostName,
        s.classId as sClsId, '' as sClsName,

        t.id as tid,
        t.category as tType, t.name as tName,
        t.mobile as tMobile, t.idCard as tIdCard, t.photoUrl as tPhotoUrl
        from portal.users u
        left join portal.userinfo ui on u.openId = ui.unionid
        left join partyschool.student s on u.user_id = s.id
        left join partyschool.teacher t on u.user_id = t.id
        where u.account = #{acct,jdbcType=VARCHAR}
    </select>
</mapper>