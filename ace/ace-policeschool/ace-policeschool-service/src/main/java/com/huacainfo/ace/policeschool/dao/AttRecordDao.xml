<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huacainfo.ace.policeschool.dao.AttRecordDao">
    <resultMap id="BaseResultMap" type="com.huacainfo.ace.policeschool.model.AttRecord">
        <id column="attenId" jdbcType="VARCHAR" property="attenId"/>
        <result column="companyId" jdbcType="VARCHAR" property="companyId"/>
        <result column="attenDevice" jdbcType="VARCHAR" property="attenDevice"/>
        <result column="deviceName" jdbcType="VARCHAR" property="deviceName"/>
        <result column="attenUid" jdbcType="VARCHAR" property="attenUid"/>
        <result column="realname" jdbcType="VARCHAR" property="realname"/>
        <result column="departName" jdbcType="VARCHAR" property="departName"/>
        <result column="attenType" jdbcType="VARCHAR" property="attenType"/>
        <result column="attenStatus" jdbcType="VARCHAR" property="attenStatus"/>
        <result column="attenTime" jdbcType="BIGINT" property="attenTime"/>
        <result column="attenDate" jdbcType="VARCHAR" property="attenDate"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="createDate" jdbcType="TIMESTAMP" property="createDate"/>
    </resultMap>
    <sql id="Base_Column_List">
        attenId, companyId, attenDevice, deviceName, attenUid, realname, departName, attenType,
    attenStatus, attenTime, attenDate, remark, createDate
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from qy_att_record
        where id = #{id,jdbcType=VARCHAR}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
        delete from qy_att_record
        where id = #{id,jdbcType=VARCHAR}
    </delete>
    <insert id="insert" parameterType="com.huacainfo.ace.policeschool.model.AttRecord">
    insert into qy_att_record (attenId, companyId, attenDevice,
      deviceName, attenUid, realname,
      departName, attenType, attenStatus,
      attenTime, attenDate, remark,
      createDate)
    values (#{attenId,jdbcType=VARCHAR}, #{companyId,jdbcType=VARCHAR}, #{attenDevice,jdbcType=VARCHAR},
      #{deviceName,jdbcType=VARCHAR}, #{attenUid,jdbcType=VARCHAR}, #{realname,jdbcType=VARCHAR},
      #{departName,jdbcType=VARCHAR}, #{attenType,jdbcType=VARCHAR}, #{attenStatus,jdbcType=VARCHAR},
      #{attenTime,jdbcType=BIGINT}, #{attenDate,jdbcType=VARCHAR}, #{remark,jdbcType=VARCHAR},
      #{createDate,jdbcType=TIMESTAMP})
  </insert>

    <update id="updateByPrimaryKey" parameterType="com.huacainfo.ace.policeschool.model.AttRecord">
    update qy_att_record
    set companyId = #{companyId,jdbcType=VARCHAR},
      attenDevice = #{attenDevice,jdbcType=VARCHAR},
      deviceName = #{deviceName,jdbcType=VARCHAR},
      attenUid = #{attenUid,jdbcType=VARCHAR},
      realname = #{realname,jdbcType=VARCHAR},
      departName = #{departName,jdbcType=VARCHAR},
      attenType = #{attenType,jdbcType=VARCHAR},
      attenStatus = #{attenStatus,jdbcType=VARCHAR},
      attenTime = #{attenTime,jdbcType=BIGINT},
      attenDate = #{attenDate,jdbcType=VARCHAR},
      remark = #{remark,jdbcType=VARCHAR},
      createDate = #{createDate,jdbcType=TIMESTAMP}
    where attenId = #{attenId,jdbcType=VARCHAR}
  </update>

    <resultMap id="VoResultMap" extends="BaseResultMap" type="com.huacainfo.ace.policeschool.vo.AttRecordVo">
        <result column="userName" jdbcType="VARCHAR" property="userName"/>
        <result column="userTypeName" jdbcType="VARCHAR" property="userTypeName"/>
        <result column="attenDateTime" jdbcType="VARCHAR" property="attenDateTime"/>
        <result column="attDate" jdbcType="VARCHAR" property="attDate"/>
    </resultMap>

    <sql id="Vo_Column_List">

       stu.id as userId,stu.name as userName,att.attenId,att.companyId,att.attenDevice,att.deviceName,att.departName,att.attenUid,att.realname,att.attenType,att.attenStatus,
        DATE_FORMAT(from_unixtime(att.attenTime),'%Y-%m-%d %H:%i:%S') as attenDateTime,
      att.attenDate,cls.id as classId
    </sql>
    <sql id="From_Statement">
       FROM student stu

      LEFT JOIN  qy_crm crm  on stu.id =crm.userId
     LEFT JOIN qy_att_record att on att.attenUid =crm.ccNum
     LEFT JOIN classes cls on stu.classId=cls.id

    </sql>
    <sql id="Where_Condition">
        where 1 = 1
        <if test="condition.userId !=null and condition.userId !=&quot;&quot;">
            and v.id = #{condition.userId,jdbcType=VARCHAR}
        </if>

        <if test="condition.userName !=null and condition.userName !=&quot;&quot;">
            and v.name like concat(#{condition.userName,jdbcType=VARCHAR},'%')
        </if>
        <if test="condition.classId!=null and condition.classId!=&quot;&quot;">
            and v.classId = #{condition.classId,jdbcType=VARCHAR}
        </if>
        <if test="condition.dateTimeStr !=null and condition.dateTimeStr !=&quot;&quot;">
            and att.attTime like concat(#{condition.dateTimeStr,jdbcType=VARCHAR},'%')
        </if>
        <if test='condition.startDate!=null and condition.startDate!=""'>
            <![CDATA[
              and from_unixtime(att.attenTime)>= str_to_date(#{condition.startDate},'%Y-%m-%d %H:%i:%S')
            ]]>
        </if>
        <if test='condition.endDate!=null and condition.endDate!=""'>
            <![CDATA[
              and  from_unixtime(att.attenTime) <= str_to_date(#{condition.endDate},'%Y-%m-%d %H:%i:%S')
            ]]>
        </if>
    </sql>


    <select id="selectVoByPrimaryKey" parameterType="java.lang.String" resultMap="VoResultMap">
        select
        <include refid="Vo_Column_List"/>
        <include refid="From_Statement"/>
        where re.attenId = #{attenId,jdbcType=VARCHAR}
    </select>

    <select id="findList" parameterType="java.lang.String" resultMap="VoResultMap">
        select
        <include refid="Vo_Column_List"/>
        <include refid="From_Statement"/>
        <include refid="Where_Condition"/>
        <choose>
            <when test="orderBy!=null and orderBy!=&quot;&quot;">
                ORDER BY ${orderBy}
            </when>
            <otherwise>
                ORDER BY att.createDate desc
            </otherwise>
        </choose>
        limit #{start,jdbcType=DECIMAL}, #{limit,jdbcType=DECIMAL}
    </select>


    <select id="findCount" resultType="int">
        SELECT COUNT(*)
        <include refid="From_Statement"/>
        <include refid="Where_Condition"/>
    </select>

    <select id="isExist" resultType="int" parameterType="com.huacainfo.ace.policeschool.model.AttRecord">
        select count(1)
        from att_record t
        where t.attTime like concat(#{attTimeStr,jdbcType=VARCHAR},'%')
        and t.userId = #{userId,jdbcType=VARCHAR}
    </select>

    <sql id="Vo_Column_List_Expor">
    IFNULL(left(att.attenDateTime,10),#{condition.nowDate,jdbcType=VARCHAR} ) as attDate,
	stu.userName,
	stu.userId,att.attenDateTime

    </sql>
    <sql id="From_Statement_Expor">
       from (
	    select
           c.userId,
           DATE_FORMAT(from_unixtime(r.attenTime),'%Y-%m-%d %H:%i:%S') as  attenDateTime
	  from qy_crm c, qy_att_record r
	   where c.ccNum = r.attenUid
           )att
         RIGHT JOIN (
           select
		s.id as userId,s.name as userName, cls.id as classId
	FROM student s ,classes cls where s.status = '1' and  s.classId=cls.id
        )stu on stu.userId = att.userId

    </sql>
    <sql id="Where_Condition_Expor">
        where 1 = 1
        <if test="condition.userId !=null and condition.userId !=&quot;&quot;">
            and stu.id = #{condition.userId,jdbcType=VARCHAR}
        </if>

        <if test="condition.userName !=null and condition.userName !=&quot;&quot;">
            and stu.name like concat(#{condition.userName,jdbcType=VARCHAR},'%')
        </if>
        <if test="condition.classId!=null and condition.classId!=&quot;&quot;">
            and stu.classId = #{condition.classId,jdbcType=VARCHAR}
        </if>
        <if test='condition.startDate!=null and condition.startDate!=""'>
            <![CDATA[
              and IFNULL(att.attenDateTime, str_to_date(#{condition.startDate},'%Y-%m-%d %H:%i:%S'))
                  >= str_to_date(#{condition.startDate},'%Y-%m-%d %H:%i:%S')
            ]]>
        </if>
        <if test='condition.endDate!=null and condition.endDate!=""'>
            <![CDATA[
              and  IFNULL(att.attenDateTime,str_to_date(#{condition.endDate},'%Y-%m-%d %H:%i:%S'))
                    <= str_to_date(#{condition.endDate},'%Y-%m-%d %H:%i:%S')
            ]]>
        </if>
        UNION ALL
        select
        #{condition.nowDate,jdbcType=VARCHAR} as attDate, t.name userName, t.id as userId, '' as attenTime
        from student t
        where t.`status` = 1
    </sql>
    <sql id="Where_NotCondition_Expor">
        and t.id not in (
        select
        stu.userId
        from (
        select
        c.userId,
        from_unixtime(r.attenTime) as attenTime
        from qy_crm c, qy_att_record r
        where c.ccNum = r.attenUid
        )att
        RIGHT JOIN (
        select
        s.id as userId,s.name as userName, cls.id as classId
        FROM student s ,classes cls where s.status = '1' and s.classId=cls.id
        )stu on stu.userId = att.userId
        where 1=1
        <if test="condition.userId !=null and condition.userId !=&quot;&quot;">
            and stu.id = #{condition.userId,jdbcType=VARCHAR}
        </if>

        <if test="condition.userName !=null and condition.userName !=&quot;&quot;">
            and stu.name like concat(#{condition.userName,jdbcType=VARCHAR},'%')
        </if>
        <if test="condition.classId!=null and condition.classId!=&quot;&quot;">
            and stu.classId = #{condition.classId,jdbcType=VARCHAR}
        </if>
        <if test='condition.startDate!=null and condition.startDate!=""'>
            <![CDATA[
              and IFNULL(att.attenTime, str_to_date(#{condition.startDate},'%Y-%m-%d %H:%i:%S'))
                  >= str_to_date(#{condition.startDate},'%Y-%m-%d %H:%i:%S')
            ]]>
        </if>
        <if test='condition.endDate!=null and condition.endDate!=""'>
            <![CDATA[
              and  IFNULL(att.attenTime,str_to_date(#{condition.endDate},'%Y-%m-%d %H:%i:%S'))
                    <= str_to_date(#{condition.endDate},'%Y-%m-%d %H:%i:%S')
            ]]>
        </if>
        )
    </sql>
    <select id="findListExpor" parameterType="java.lang.String" resultMap="VoResultMap">
        select
        <include refid="Vo_Column_List_Expor"/>
        <include refid="From_Statement_Expor"/>
        <include refid="Where_Condition_Expor"/>
        <include refid="Where_NotCondition_Expor"/>
        <!--  <choose>
              <when test="orderBy!=null and orderBy!=&quot;&quot;">
                  ORDER BY ${orderBy}
              </when>
              <otherwise>
                  ORDER BY att.createDate desc
              </otherwise>
          </choose>-->
        limit #{start,jdbcType=DECIMAL}, #{limit,jdbcType=DECIMAL}
    </select>
</mapper>